name: Build, Run CSX & Deploy

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  PROJECT_PATH: "LIN.Cloud.Identity/LIN.Cloud.Identity.csproj"
  PUBLISH_DIR: "publish"
  FTP_HOST: ${{ secrets.FTP_HOST }}
  FTP_USER: ${{ secrets.FTP_USER }}
  FTP_PASS: ${{ secrets.FTP_PASS }}
  FTP_DIR: ${{ secrets.FTP_DIR }}
  RUNTIME_ID: "win-x64"

jobs:
  build-run-csx-deploy:
    runs-on: ubuntu-latest

    steps:
      # --------------------
      # Checkout
      # --------------------
      - name: Checkout
        uses: actions/checkout@v4

      # --------------------
      # Setup .NET
      # --------------------
      - name: Setup .NET 9 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      # --------------------
      # Cache NuGet
      # --------------------
      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/packages.lock.json', '**/*.csproj') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      # ====================
      # 1️⃣ COMPILE
      # ====================
      - name: Clean
        run: dotnet clean "$PROJECT_PATH" -c Release

      - name: Restore
        run: dotnet restore "$PROJECT_PATH" -r $RUNTIME_ID

      - name: Build
        run: dotnet build "$PROJECT_PATH" -c Release -f net9.0 -r $RUNTIME_ID --no-restore

      # ====================
      # 2️⃣ RUN CSX
      # ====================
      - name: Install dotnet-script
        run: dotnet tool install -g dotnet-script

      - name: Add tools to PATH
        run: echo "$HOME/.dotnet/tools" >> "$GITHUB_PATH"

      - name: Run all .csx scripts
        run: |
          find ./Scripts -name "*.csx" -print -exec dotnet-script {} \;

      # ====================
      # 3️⃣ PUBLISH
      # ====================
      - name: Publish
        run: |
          dotnet publish "$PROJECT_PATH" \
            -c Release \
            -f net9.0 \
            -r $RUNTIME_ID \
            --self-contained false \
            --no-build \
            -p:PublishSingleFile=false \
            -p:GenerateRuntimeConfigurationFiles=true \
            -p:DebugType=None \
            -p:DebugSymbols=false \
            -o "$PUBLISH_DIR"

      # --------------------
      # IIS: App Offline
      # --------------------
      - name: Put app offline
        run: echo "Deploying..." > publish/app_offline.htm

      # --------------------
      # DEPLOY (SFTP real)
      # --------------------
      - name: Deploy via SFTP (scp native)
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

          sshpass -p "$FTP_PASS" \
            scp -o StrictHostKeyChecking=no -P 22 -r \
            publish/* \
            $FTP_USER@$FTP_HOST:$FTP_DIR

      # --------------------
      # IIS: App Online
      # --------------------
      - name: Bring app online
        run: |
          sshpass -p "$FTP_PASS" \
            ssh -o StrictHostKeyChecking=no -p 22 \
            $FTP_USER@$FTP_HOST \
            "del /Q \"${FTP_DIR}\\app_offline.htm\""
