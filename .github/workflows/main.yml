name: Build & Deploy

on:
  workflow_run:
    workflows: ["Run CSX"]
    types:
      - completed
    branches: ["main"]

env:
  PROJECT_PATH: "LIN.Cloud.Identity/LIN.Cloud.Identity.csproj"
  PUBLISH_DIR: "publish"
  FTP_HOST: ${{ secrets.FTP_HOST }}
  FTP_USER: ${{ secrets.FTP_USER }}
  FTP_PASS: ${{ secrets.FTP_PASS }}
  FTP_DIR: ${{ secrets.FTP_DIR }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 9 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Clean
        run: dotnet clean "$PROJECT_PATH" -c Release

      - name: Restore (runtime win-x86)
        run: dotnet restore "$PROJECT_PATH" -r win-x86

      - name: Build (Release, net9.0, win-x86)
        run: dotnet build "$PROJECT_PATH" -c Release -f net9.0 -r win-x86 --no-restore

      - name: Publish (net9.0 | win-x86 | framework-dependent)
        run: |
          dotnet publish "$PROJECT_PATH" \
            -c Release \
            -f net9.0 \
            -r win-x86 \
            --self-contained false \
            --no-build \
            -p:PublishSingleFile=false \
            -p:GenerateRuntimeConfigurationFiles=true \
            -p:DebugType=None \
            -p:DebugSymbols=false \
            -o "$PUBLISH_DIR"

      - name: Deploy via SFTP (SCP)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USER }}
          password: ${{ secrets.FTP_PASS }}
          port: 22
          source: "publish/*"
          target: ${{ secrets.FTP_DIR }}
          strip_components: 1
